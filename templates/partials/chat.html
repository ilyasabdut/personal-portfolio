<div x-data="chatStream()" class="chat-box">
  <div class="chat-header" @click="toggleChat">
    <h3 class="chat-title">Ask Me!</h3>
    <button id="chat-toggle-btn" class="chat-toggle-btn">🗖</button>
  </div>

  <div id="chat-body" class="chat-body">
    <div id="messages" class="chat-messages" x-ref="messages">
      <template x-for="msg in messages" :key="msg.id">
        <div class="bubble" :class="msg.type" :id="'msg-' + msg.id">
          <template x-if="msg.content === 'typing...'">
            <div class="dot-typing">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </template>
          <template x-if="msg.content !== 'typing...'">
            <span x-html="msg.content"></span>
          </template>
        </div>
      </template>
    </div>

    <form @submit.prevent="sendMessage" class="chat-form">
      <input x-model="input" type="text" placeholder="Type your message..." required class="chat-input" />
    </form>
  </div>
</div>

<script>

function chatStream() {
  return {
    input: '',
    messages: [],
    eventSource: null,
    sessionId: '',

    init() {
      this.loadSession(); // Load session and messages from localStorage if available
    },

    loadSession() {
      // Generate a new session ID if none exists in localStorage
      if (!localStorage.getItem('session_id')) {
        this.sessionId = this.generateSessionId();
        localStorage.setItem('session_id', this.sessionId);
      } else {
        this.sessionId = localStorage.getItem('session_id');
      }

      // Check for messages in localStorage for the current session
      const savedMessages = localStorage.getItem(`chatMessages-${this.sessionId}`);
      if (savedMessages) {
        this.messages = JSON.parse(savedMessages);
        // Scroll to bottom after loading from storage
        this.$nextTick(() => {
          this.$refs.messages.scrollTop = this.$refs.messages.scrollHeight;
        });
      }

      // Fetch session data if messages are not in localStorage
      fetch("/session", { 
        credentials: "include",
        headers: { 'Cache-Control': 'no-cache' }
      })
      .then((res) => res.json())
      .then((data) => {
        if (data && data.session_id && Array.isArray(data.messages)) {
          // Merge any new messages with the ones from localStorage
          this.messages = this.messages.concat(data.messages.map((msg, i) => {
            const id = Date.now() + i;
            return { id, type: msg.role === "user" ? "user-bubble" : "llm-bubble", content: msg.content };
          }));
          // Save to localStorage for this session
          localStorage.setItem(`chatMessages-${this.sessionId}`, JSON.stringify(this.messages));

          // Scroll to bottom after loading
          this.$nextTick(() => {
            this.$refs.messages.scrollTop = this.$refs.messages.scrollHeight;
          });
        }
      })
      .catch((err) => {
        console.error("Failed to load session:", err);
      });
    },

    toggleChat() {
      const body = document.getElementById("chat-body");
      const btn = document.getElementById("chat-toggle-btn");
      const isHidden = body.style.display === "none";
      body.style.display = isHidden ? "block" : "none";
      btn.textContent = isHidden ? "_" : "🗖";
    },

    decodeHTML(html) {
      const txt = document.createElement("textarea");
      txt.innerHTML = html;
      return txt.value;
    },

    sendMessage() {
      const msg = this.input.trim();
      if (!msg) return;

      this.input = '';
      const userId = Date.now();
      this.messages.push({ id: userId, type: 'user-bubble', content: msg });

      // Save the updated messages to localStorage
      localStorage.setItem(`chatMessages-${this.sessionId}`, JSON.stringify(this.messages));

      this.$nextTick(() => {
        this.$refs.messages.scrollTop = this.$refs.messages.scrollHeight;
      });

      const llmId = userId + 1;
      this.messages.push({ id: llmId, type: 'llm-bubble', content: 'typing...' });

      // Save to localStorage again after adding typing indicator
      localStorage.setItem(`chatMessages-${this.sessionId}`, JSON.stringify(this.messages));

      // Close any existing connection
      if (this.eventSource) {
        this.eventSource.close();
        this.eventSource = null;
      }

      const queryParams = new URLSearchParams({ message: msg }).toString();

      try {
        this.eventSource = new EventSource(`/chat?${queryParams}`, {
          withCredentials: true
        });

        let responseText = '';

        this.eventSource.onmessage = (event) => {
          const msgObj = this.messages.find(m => m.id === llmId);
          if (msgObj.content === 'typing...') {
            responseText = '';
            msgObj.content = '';
          }

          const decodedData = this.decodeHTML(event.data);
          responseText += decodedData;

          msgObj.content = responseText;

          // Save to localStorage every time the message updates
          localStorage.setItem(`chatMessages-${this.sessionId}`, JSON.stringify(this.messages));

          this.$nextTick(() => {
            this.$refs.messages.scrollTop = this.$refs.messages.scrollHeight;
          });
        };

        this.eventSource.addEventListener('complete', () => {
          if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
          }
        });

        this.eventSource.onerror = (event) => {
          console.error("SSE connection error:", event);
          const msgObj = this.messages.find(m => m.id === llmId);
          if (msgObj && msgObj.content === 'typing...') {
            msgObj.content = "⚠️ Network error. Try again.";
          }

          if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
          }

          // Save to localStorage after error
          localStorage.setItem(`chatMessages-${this.sessionId}`, JSON.stringify(this.messages));
        };
      } catch (error) {
        console.error("Failed to create EventSource:", error);
        const msgObj = this.messages.find(m => m.id === llmId);
        if (msgObj) {
          msgObj.content = "⚠️ Failed to connect to server.";
        }

        // Save to localStorage in case of failure
        localStorage.setItem(`chatMessages-${this.sessionId}`, JSON.stringify(this.messages));
      }
    },

    // Generate a random session ID if needed
    generateSessionId() {
      return 'xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'.replace(/[x]/g, () => (Math.random() * 16 | 0).toString(16));
    }
  }
}
</script>
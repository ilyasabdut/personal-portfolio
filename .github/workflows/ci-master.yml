name: Build and Deploy

on:
  push:
    branches:
      - master

jobs:
  # build:
  #   runs-on: ubuntu-latest
  #   environment: master

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Log in to Docker registry
  #       run: echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login registry.ilyasabdut.loseyourip.com -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

  #     - name: Build and Push Docker Image
  #       run: |
  #         docker build -t registry.ilyasabdut.loseyourip.com/personal-portfolio:latest . --no-cache --push

  deployment:
    # needs: build
    runs-on: ubuntu-latest
    environment: master
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          # oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          # oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          # tags: tag:ci
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Add SSH private key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy to VPS via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_TAILSCALE_IP }} << 'EOF'
          set -ex
          echo "Deploying on $(hostname)"
          cd /composes/portfolio

          echo "Logging into Docker registry..."
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ secrets.REGISTRY_URL }} -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

          echo "Pulling latest image..."
          docker compose pull

          echo "Restarting container..."
          docker compose down
          docker compose up -d

          echo "Deployment complete âœ…"
          EOF
